// Prisma Schema for Project Manager SaaS
// Database: MySQL
// Multi-tenant architecture

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANTS (Multi-tenancy)
// ============================================
model Tenant {
  id          String   @id @default(uuid()) @db.Char(36)
  name        String   @db.VarChar(255)
  subdomain   String?  @unique @db.VarChar(100)
  plan        TenantPlan @default(FREE)
  status      TenantStatus @default(ACTIVE)
  maxUsers    Int      @default(10) @map("max_users")
  maxProjects Int      @default(5) @map("max_projects")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       User[]
  profiles    Profile[]
  projects    Project[]
  invitations Invitation[]
  tasks       Task[]
  comments    TaskComment[]
  attachments TaskAttachment[]
  activities  ActivityLog[]
  projectMembers ProjectMember[]
  joinRequests JoinRequest[]
  notifications Notification[]

  @@index([subdomain])
  @@index([status])
  @@map("tenants")
}

enum TenantPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

// ============================================
// USERS (Authentication)
// ============================================
model User {
  id                    String    @id @default(uuid()) @db.Char(36)
  tenantId              String    @map("tenant_id") @db.Char(36)
  email                 String    @db.VarChar(255)
  passwordHash          String    @map("password_hash") @db.VarChar(255)
  emailVerified         Boolean   @default(false) @map("email_verified")
  emailVerificationToken String?  @map("email_verification_token") @db.VarChar(255)
  passwordResetToken    String?   @map("password_reset_token") @db.VarChar(255)
  passwordResetExpires  DateTime? @map("password_reset_expires")
  lastLogin             DateTime? @map("last_login")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  tenant                Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  profile               Profile?

  @@unique([email, tenantId], name: "unique_email_tenant")
  @@index([tenantId])
  @@index([email])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
  @@map("users")
}

// ============================================
// PROFILES (User Information)
// ============================================
model Profile {
  id        String   @id @default(uuid()) @db.Char(36)
  tenantId  String   @map("tenant_id") @db.Char(36)
  email     String   @db.VarChar(255)
  name      String   @db.VarChar(255)
  avatarUrl String?  @map("avatar_url") @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [id], references: [id], onDelete: Cascade)

  createdProjects    Project[]        @relation("ProjectCreator")
  projectMemberships ProjectMember[]
  assignedTasks      Task[]           @relation("TaskAssignee")
  createdTasks       Task[]           @relation("TaskCreator")
  sentInvitations    Invitation[]
  taskComments       TaskComment[]
  taskAttachments    TaskAttachment[]
  activities         ActivityLog[]
  joinRequests       JoinRequest[]
  notifications      Notification[]

  @@index([tenantId])
  @@index([email])
  @@map("profiles")
}

// ============================================
// PROJECTS
// ============================================
model Project {
  id          String          @id @default(uuid()) @db.Char(36)
  tenantId    String          @map("tenant_id") @db.Char(36)
  name        String          @db.VarChar(255)
  description String?         @db.Text
  code        String          @unique @db.VarChar(20)
  status      ProjectStatus   @default(ACTIVE)
  color       String          @default("#14b8a6") @db.VarChar(7)
  createdBy   String?         @map("created_by") @db.Char(36)
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator     Profile?        @relation("ProjectCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  members     ProjectMember[]
  invitations Invitation[]
  tasks       Task[]
  activities  ActivityLog[]
  joinRequests JoinRequest[]
  notifications Notification[]

  @@index([tenantId])
  @@index([createdBy])
  @@index([status])
  @@index([code])
  @@map("projects")
}

enum ProjectStatus {
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

// ============================================
// PROJECT MEMBERS
// ============================================
model ProjectMember {
  id        String      @id @default(uuid()) @db.Char(36)
  tenantId  String      @map("tenant_id") @db.Char(36)
  projectId String      @map("project_id") @db.Char(36)
  userId    String      @map("user_id") @db.Char(36)
  role      ProjectRole @default(MEMBER)
  joinedAt  DateTime    @default(now()) @map("joined_at")

  tenant    Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      Profile     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId], name: "unique_project_user")
  @@index([tenantId])
  @@index([projectId])
  @@index([userId])
  @@index([role])
  @@map("project_members")
}

enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================
// INVITATIONS
// ============================================
model Invitation {
  id        String           @id @default(uuid()) @db.Char(36)
  tenantId  String           @map("tenant_id") @db.Char(36)
  projectId String           @map("project_id") @db.Char(36)
  email     String           @db.VarChar(255)
  role      InvitationRole   @default(MEMBER)
  status    InvitationStatus @default(PENDING)
  invitedBy String?          @map("invited_by") @db.Char(36)
  token     String           @default(uuid()) @db.Char(36)
  createdAt DateTime         @default(now()) @map("created_at")
  expiresAt DateTime         @map("expires_at")

  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  inviter   Profile?         @relation(fields: [invitedBy], references: [id], onDelete: SetNull)

  @@unique([projectId, email], name: "unique_project_email")
  @@index([tenantId])
  @@index([projectId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
  @@map("invitations")
}

enum InvitationRole {
  ADMIN
  MEMBER
  VIEWER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

// ============================================
// TASKS
// ============================================
model Task {
  id          String       @id @default(uuid()) @db.Char(36)
  tenantId    String       @map("tenant_id") @db.Char(36)
  projectId  String       @map("project_id") @db.Char(36)
  title       String       @db.VarChar(255)
  description String?      @db.Text
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  assigneeId  String?      @map("assignee_id") @db.Char(36)
  dueDate     DateTime?    @map("due_date")
  tags        Json?        @default("[]")
  createdBy   String?      @map("created_by") @db.Char(36)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee    Profile?     @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  creator     Profile?     @relation("TaskCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  comments    TaskComment[]
  attachments TaskAttachment[]

  @@index([tenantId])
  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@map("tasks")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================
// TASK COMMENTS
// ============================================
model TaskComment {
  id        String   @id @default(uuid()) @db.Char(36)
  tenantId  String   @map("tenant_id") @db.Char(36)
  taskId    String   @map("task_id") @db.Char(36)
  userId    String   @map("user_id") @db.Char(36)
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([taskId])
  @@index([userId])
  @@index([createdAt])
  @@map("task_comments")
}

// ============================================
// TASK ATTACHMENTS
// ============================================
model TaskAttachment {
  id        String   @id @default(uuid()) @db.Char(36)
  tenantId  String   @map("tenant_id") @db.Char(36)
  taskId    String   @map("task_id") @db.Char(36)
  userId    String   @map("user_id") @db.Char(36)
  fileName  String   @map("file_name") @db.VarChar(255)
  filePath  String   @map("file_path") @db.Text
  fileSize  Int      @map("file_size")
  fileType  String   @map("file_type") @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([taskId])
  @@index([userId])
  @@map("task_attachments")
}

// ============================================
// ACTIVITY LOG
// ============================================
model ActivityLog {
  id         String   @id @default(uuid()) @db.Char(36)
  tenantId   String   @map("tenant_id") @db.Char(36)
  projectId  String   @map("project_id") @db.Char(36)
  userId     String?  @map("user_id") @db.Char(36)
  action     String   @db.VarChar(100)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   String?  @map("entity_id") @db.Char(36)
  entityName String?  @map("entity_name") @db.VarChar(255)
  details    Json?
  createdAt  DateTime @default(now()) @map("created_at")

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       Profile? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([projectId])
  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@map("activity_log")
}

// ============================================
// JOIN REQUESTS
// ============================================
model JoinRequest {
  id        String            @id @default(uuid()) @db.Char(36)
  tenantId  String            @map("tenant_id") @db.Char(36)
  projectId String            @map("project_id") @db.Char(36)
  userId    String            @map("user_id") @db.Char(36)
  status    JoinRequestStatus @default(PENDING)
  message   String?           @db.Text
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  tenant    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  project   Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      Profile           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@unique([projectId, userId], name: "unique_project_user_request")
  @@index([tenantId])
  @@index([projectId])
  @@index([userId])
  @@index([status])
  @@map("join_requests")
}

enum JoinRequestStatus {
  PENDING
  ACCEPTED
  DECLINED
}

// ============================================
// NOTIFICATIONS
// ============================================
model Notification {
  id        String             @id @default(uuid()) @db.Char(36)
  tenantId  String             @map("tenant_id") @db.Char(36)
  userId    String             @map("user_id") @db.Char(36)
  type      NotificationType   @default(JOIN_REQUEST)
  title     String             @db.VarChar(255)
  message   String             @db.Text
  projectId String?            @map("project_id") @db.Char(36)
  joinRequestId String?        @map("join_request_id") @db.Char(36)
  read      Boolean            @default(false)
  createdAt DateTime           @default(now()) @map("created_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user          Profile        @relation(fields: [userId], references: [id], onDelete: Cascade)
  project       Project?       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  joinRequest   JoinRequest?   @relation(fields: [joinRequestId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([projectId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  JOIN_REQUEST
  INVITATION
  TASK_ASSIGNED
  TASK_COMMENT
  PROJECT_UPDATE
}

